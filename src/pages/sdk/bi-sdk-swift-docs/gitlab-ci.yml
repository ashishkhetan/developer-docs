.build-bi-sdk-swift-docs-base:
  extends:
    # Note that .zeroenv-env declares a before_script, and jobs can only have one
    # before_script, so do not specify another before_script in this job.
    - .zeroenv-env
  stage: build
  script:
    - env
    - !reference [.login-sharedservices-ecr, script]
    - !reference [.login-docker-hub, script]
    - env
    # Build/tag for shared services ECR
    - ECR_REPO_BASE=$SHARED_SERVICES_USW2_ECR_REPO_BASE
      IMAGE_TAG=$IMAGE_TAG
      make -C services/developer-docs/sdk/bi-sdk-swift-docs build
    # Push shared services ECR
    - ECR_REPO_BASE=$SHARED_SERVICES_USW2_ECR_REPO_BASE
      IMAGE_TAG=$IMAGE_TAG
      make -C services/developer-docs/sdk/bi-sdk-swift-docs push
  needs: []
  retry:
    max: 2
    when:
      - runner_system_failure

build-bi-sdk-swift-docs-devel:
  extends:
    - .build-bi-sdk-swift-docs-base
    - .devel-env
  rules:
    - !reference [.devel-env-default-rules, rules]
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/comms/device/device.proto
        - clients/shared/**/*
        - clients/localization/**/*
        - clients/core/**/*
        - clients/core_sdk/swift/**/*
        - clients/features/*/swift/**/*
        - clients/external_sdks/scripts/apple/**/*
        - clients/external_sdks/bi-sdk-swift/**/*
        - clients/external_sdks/bi-sdk-react-native/**/*
        - clients/external_sdks/bi-sdk-flutter/**/*
        # - services/developer-docs/sdk/bi-sdk-swift-docs/**/*
  interruptible: true
  variables:
    ECR_REPO_NAME: beyondidentity-dev/bi-sdk-swift-docs
    IMAGE_TAG: devel-$CI_COMMIT_SHA
  allow_failure: true
  needs:
    - job: "build-bi-sdk-swift-devel"
  tags:
    - amazon-linux-2-development

build-bi-sdk-swift-docs-rolling:
  extends:
    - .build-bi-sdk-swift-docs-base
    - .rolling-env
  rules:
    # Master
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - proto/comms/device/device.proto
        - clients/shared/**/*
        - clients/localization/**/*
        - clients/core/**/*
        - clients/core_sdk/swift/**/*
        - clients/features/*/swift/**/*
        - clients/external_sdks/scripts/apple/**/*
        - clients/external_sdks/bi-sdk-swift/**/*
        - clients/external_sdks/bi-sdk-react-native/**/*
        - clients/external_sdks/bi-sdk-flutter/**/*
        # - services/developer-docs/sdk/bi-sdk-swift-docs/**/*
  variables:
    ECR_REPO_NAME: beyondidentity/bi-sdk-swift-docs
    IMAGE_TAG: $CI_COMMIT_SHA
  needs:
    - job: "build-bi-sdk-swift-rolling"
  tags:
    - amazon-linux-2-rolling

build-bi-sdk-swift-docs-staging:
  extends:
    - .build-bi-sdk-swift-docs-base
    - .staging-env
  rules:
    - if: '$CI_COMMIT_TAG =~ /^bi-sdk-swift-v[0-9]+\.[0-9]+\.[0-9]+\-rc[0-9]+$/'
  variables:
    ECR_REPO_NAME: beyondidentity/bi-sdk-swift-docs
    IMAGE_TAG: $CI_COMMIT_REF_NAME
  needs:
    - job: "build-bi-sdk-swift-staging"
  tags:
    - amazon-linux-2-staging

build-bi-sdk-swift-docs-production:
  extends:
    - .build-bi-sdk-swift-docs-base
    - .production-env
  rules:
    - if: '$CI_COMMIT_TAG =~ /^bi-sdk-swift-v[0-9]+\.[0-9]+\.[0-9]+\-rc[0-9]+$/'
  variables:
    ECR_REPO_NAME: beyondidentity/bi-sdk-swift-docs
    IMAGE_TAG: $CI_COMMIT_REF_NAME
  needs:
    - job: "build-bi-sdk-swift-production"
  tags:
    - amazon-linux-2-production

cosign-devel-bi-sdk-swift-docs:
  extends:
    - .devel-env
    - .sign-image-with-cosign
  interruptible: true
  allow_failure: true
  rules:
    - !reference [.devel-env-default-rules, rules]
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/comms/device/device.proto
        - clients/shared/**/*
        - clients/localization/**/*
        - clients/core/**/*
        - clients/core_sdk/swift/**/*
        - clients/features/*/swift/**/*
        - clients/external_sdks/scripts/apple/**/*
        - clients/external_sdks/bi-sdk-swift/**/*
        - clients/external_sdks/bi-sdk-react-native/**/*
        - clients/external_sdks/bi-sdk-flutter/**/*
        # - services/developer-docs/sdk/bi-sdk-swift-docs/**/*
  needs:
    - job: "build-bi-sdk-swift-docs-devel"
      artifacts: false
  variables:
    ECR_REPO_BASE: "${SHARED_SERVICES_USW2_ECR_REPO_BASE}"
    ECR_REPO_NAME: beyondidentity-dev/bi-sdk-swift-docs
    IMAGE_TAG: devel-$CI_COMMIT_SHA

deploy-bi-sdk-swift-docs-devel:
  extends: .deploy-cloud-svc-devel-base
  rules:
    - !reference [.devel-env-default-rules, rules]
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - proto/comms/device/device.proto
        - clients/shared/**/*
        - clients/localization/**/*
        - clients/core/**/*
        - clients/core_sdk/swift/**/*
        - clients/features/*/swift/**/*
        - clients/external_sdks/scripts/apple/**/*
        - clients/external_sdks/bi-sdk-swift/**/*
        - clients/external_sdks/bi-sdk-react-native/**/*
        - clients/external_sdks/bi-sdk-flutter/**/*
        # - services/developer-docs/sdk/bi-sdk-swift-docs/**/*
  variables:
    IMAGE_TAG: devel-$CI_COMMIT_SHA
    HELM_ENV_VALUES_FILE: "./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs/values-devel.yaml"
  script:
    - export HELM_ADDITIONAL_SET_VARS="--set \"ingressByndid.tls[0].hosts[0]=docs-$DEVEL_BRANCH_FULL_DOMAIN,ingressByndid.hosts[0].host=docs-$DEVEL_BRANCH_FULL_DOMAIN"
    - helm -n $KUBE_NAMESPACE template bi-sdk-swift-docs ./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs
      -f $HELM_ENV_VALUES_FILE
      --set image.tag=$IMAGE_TAG
      $HELM_ADDITIONAL_SET_VARS
    - helm -n $KUBE_NAMESPACE upgrade --install --wait bi-sdk-swift-docs ./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs
      -f $HELM_ENV_VALUES_FILE
      --set image.tag=$IMAGE_TAG
      $HELM_ADDITIONAL_SET_VARS
  needs:
    - job: "build-bi-sdk-swift-docs-devel"
      artifacts: false
    - job: "cosign-devel-bi-sdk-swift-docs"
      artifacts: false
    - job: "deploy-cloud-base-devel"
      artifacts: false

deploy-bi-sdk-swift-docs-rolling:
  # See: ci/gitlab-config/jobs/cloud/argo.yml
  extends: .deploy-reset-argo-branch-base
  rules:
    # Master
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - proto/comms/device/device.proto
        - clients/shared/**/*
        - clients/localization/**/*
        - clients/core/**/*
        - clients/core_sdk/swift/**/*
        - clients/features/*/swift/**/*
        - clients/external_sdks/scripts/apple/**/*
        - clients/external_sdks/bi-sdk-swift/**/*
        - clients/external_sdks/bi-sdk-react-native/**/*
        - clients/external_sdks/bi-sdk-flutter/**/*
        # - services/developer-docs/sdk/bi-sdk-swift-docs/**/*
  variables:
    IMAGE_TAG: $CI_COMMIT_SHA
    ARGO_BRANCH: argo-bi-sdk-swift-docs-deploy-rolling
    VALUES_IMAGE_FILE: "./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs/values-image-rolling.yaml"
  needs:
    - job: "build-bi-sdk-swift-docs-rolling"
      artifacts: false

deploy-bi-sdk-swift-docs-staging:
  # See: ci/gitlab-config/jobs/cloud/argo.yml
  extends: .deploy-reset-argo-branch-base
  rules:
    - if: '$CI_COMMIT_TAG =~ /^bi-sdk-swift-v[0-9]+\.[0-9]+\.[0-9]+\-rc[0-9]+$/'
      when: manual
  variables:
    IMAGE_TAG: $CI_COMMIT_REF_NAME
    ARGO_BRANCH: argo-bi-sdk-swift-docs-deploy-staging
    VALUES_IMAGE_FILE: "./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs/values-image-staging.yaml"
  needs:
    - job: "build-bi-sdk-swift-docs-staging"
      artifacts: false

deploy-bi-sdk-swift-docs-production:
  # See: ci/gitlab-config/jobs/cloud/argo.yml
  extends: .deploy-reset-argo-branch-base
  rules:
    - if: '$CI_COMMIT_TAG =~ /^bi-sdk-swift-v[0-9]+\.[0-9]+\.[0-9]+\-rc[0-9]+$/'
      when: manual
  variables:
    IMAGE_TAG: $CI_COMMIT_REF_NAME
    ARGO_BRANCH: argo-bi-sdk-swift-docs-deploy-production
    VALUES_IMAGE_FILE: "./services/developer-docs/sdk/bi-sdk-swift-docs/helm/bi-sdk-swift-docs/values-image-production.yaml"
  needs:
    - job: "build-bi-sdk-swift-docs-production"
      artifacts: false
